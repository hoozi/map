"use strict";function _objectSpread(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};var a=Object.keys(e);if(typeof Object.getOwnPropertySymbols==="function"){a=a.concat(Object.getOwnPropertySymbols(e).filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))}a.forEach(function(t){_defineProperty(i,t,e[t])})}return i}function _defineProperties(t,i){for(var e=0;e<i.length;e++){var a=i[e];a.enumerable=a.enumerable||false;a.configurable=true;if("value"in a)a.writable=true;Object.defineProperty(t,a.key,a)}}function _createClass(t,i,e){if(i)_defineProperties(t.prototype,i);if(e)_defineProperties(t,e);return t}function _defineProperty(t,i,e){if(i in t){Object.defineProperty(t,i,{value:e,enumerable:true,configurable:true,writable:true})}else{t[i]=e}return t}function _classCallCheck(t,i){if(!(t instanceof i)){throw new TypeError("Cannot call a class as a function")}}function getWindowSize(){var t=window.innerWidth;var i=window.innerHeight;return{width:t,height:i}}var mapConfig={siteWidth:40,siteHeight:40,siteMargin:8,offset:{dx:0,dy:34},padding:{top:0,bottom:0,left:24,right:24},radarSiteWidth:4,radarSiteHeight:4,radarSiteMargin:2,siteSelectedColor:"#389e0d",siteColor:"#fff",siteCtnColor:"#fa541c"};var getPixelRatio=function t(){var i=document.createElement("canvas");var e=i.getContext("2d");var a=window.devicePixelRatio||1;var s=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;var r=a/s;i=null;e=null;return r>2?2:Math.round(r)};var Site=function t(){_classCallCheck(this,t)};var YardMap=function(){function e(t){var n=this;_classCallCheck(this,e);_defineProperty(this,"handleMapTap",function(t){t.preventDefault();var i=t.center.x-n.mapOffset.left-n.dx,e=t.center.y-n.mapOffset.top-n.dy,a=i/n.scale,s=e/n.scale,r=n.getTapedSite(a,s)[0];if(n.scale!==1){n.setMatrix({scale:1,dx:n.dx+Math.round(i-a),dy:n.dy+Math.round(e-s)});n.checkBoundary();n.updateMap()}n.showRadar();if(r){n.selectSeats(r)}});this.mapConfig=$.extend({},mapConfig,t);this.mapCanvas=document.querySelector(".canvas-map");this.mapCtx=this.mapCanvas.getContext("2d");this.xindex=$(".x-index");this.yindex=$(".y-index");this.indexItems=$("#index-items").html();this.radarElement=document.querySelector(".radar");this.radarCanvas=document.querySelector(".canvas-radar");this.radarCtx=this.radarCanvas.getContext("2d");this.radarFrame=document.querySelector(".radar-frame");this.siteWidth=this.mapConfig.siteWidth;this.siteHeight=this.mapConfig.siteHeight;this.siteMargin=this.mapConfig.siteMargin;this.viewWidth=this.mapConfig.viewWidth||window.innerWidth;this.viewHeight=this.mapConfig.viewHeight||window.innerHeight;this.data=this.mapConfig.data||{};this.maxRadarWidth=.5*this.viewWidth;this.dy=0;this.dx=0;this.scale=1;this.maxScale=1;this.radarScale=1;this.dpr=getPixelRatio();this.mapData=this.getMapData(this.data);this.mapWidth=this.mapData.mapWidth;this.mapHeight=this.mapData.mapHeight;this.radarWidth=this.mapData.radarWidth;this.radarHeight=this.mapData.radarHeight;var i=$(this.mapCanvas).offset();this.mapOffset=_objectSpread({},i);this.selectedSites=[];this.selectedPrevSite={};this.initScale();this.createIndex();this.bindEvent();this.init()}_createClass(e,[{key:"init",value:function t(){this.initSize();this.initRadar();this.setMatrix({dx:Math.round((this.viewWidth-this.mapWidth*this.scale)/2),dy:this.mapConfig.offset.dy});this.renderMap(this.mapCtx);this.renderRadar(this.radarCtx)}},{key:"initSize",value:function t(){this.mapCanvas.width=this.viewWidth*this.dpr;this.mapCanvas.height=this.viewHeight*this.dpr;this.mapCanvas.style.width="".concat(this.viewWidth,"px");this.mapCanvas.style.height="".concat(this.viewHeight,"px")}},{key:"createIndex",value:function t(){this.xIndex={columns:this.getIndexName("x"),columnWidth:this.mapConfig.siteWidth+this.mapConfig.siteMargin};this.yIndex={rows:this.getIndexName("y"),rowHeight:this.mapConfig.siteHeight+this.mapConfig.siteMargin};var i=_.template(this.indexItems)({data:this.yIndex,scale:this.scale});var e=_.template(this.indexItems)({data:this.xIndex,scale:this.scale});this.yindex.html(i);this.xindex.css({width:this.mapWidth,left:Math.round((this.viewWidth-this.mapWidth*this.scale)/2)+20*this.scale}).html(e)}},{key:"getMapData",value:function t(i){var e=i.maxColumn,a=i.maxRow,s=i.minColumn,r=i.minRow,n=i.site;var h=this.mapConfig,d=h.siteWidth,o=h.siteMargin,c=h.siteHeight,l=h.padding,f=h.radarSiteWidth,m=h.radarSiteHeight,p=h.radarSiteMargin;var u=d*e+o*(e-1)+l.left+l.right;var v=(c+o)*a+l.top;var g=f*e+p*(+e+1);var x=(m+p)*a;return{maxColumn:e,minColumn:s,maxRow:a,minRow:r,mapWidth:u,mapHeight:v,radarWidth:g,radarHeight:x,site:n.map(function(t){var i=t.column,e=t.row;var a=(d+o)*(i-1)+l.left;var s=(c+o)*(e-1)+l.top;var r=(f+p)*(i-1)+p;var n=(m+p)*(e-1)+p;return _objectSpread({},t,{vx:a,vy:s,rx:r,ry:n})})}}},{key:"getTapedSite",value:function t(r,n){var h=this;return this.mapData.site.filter(function(t){var i=t.vx,e=t.vy;var a=i+h.mapConfig.siteWidth;var s=e+h.mapConfig.siteHeight;return i<=r&&r<=a&&e<=n&&n<=s})}},{key:"getIndexName",value:function t(i){var e=this.mapData,a=e.minColumn,s=e.maxColumn,r=e.minRow,n=e.maxRow;var h=[];var d={x:{min:+a,max:+s,group:_.groupBy(this.mapData.site,function(t){return t.column})},y:{min:+r,max:+n,group:_.groupBy(this.mapData.site,function(t){return t.row})}};for(var o=d[i].min;o<d[i].max+1;o++){h.push({index:o})}return h}},{key:"initScale",value:function t(){var i=Math.min((this.viewHeight-this.mapConfig.offset.dy)/this.mapHeight,(this.viewWidth-this.mapConfig.offset.dx)/this.mapWidth);if(this.viewHeight>=this.mapHeight&&this.viewWidth>=this.mapWidth){i=1}this.minScale=i;this.scale=i}},{key:"initRadar",value:function t(){if(!this.mapConfig.radar)return;var i=this.radarWidth,e=this.radarHeight;if(i>e&&i>this.maxRadarWidth){this.radarScale=this.maxRadarWidth/i;e*=this.radarScale;i=this.maxRadarWidth}else{if(e>i&&e>this.maxRadarWidth){this.radarScale=this.maxRadarWidth/e;i*=this.radarScale;e=this.maxRadarWidth}}this.radarWidth=i;this.radarHeight=e;this.radarCanvas.width=i*this.dpr;this.radarCanvas.height=e*this.dpr;this.radarCanvas.style.width="".concat(this.radarWidth,"px");this.radarCanvas.style.height="".concat(this.radarHeight,"px");this.radarCtx.scale(this.dpr*this.radarScale,this.dpr*this.radarScale)}},{key:"bindEvent",value:function t(){var d=this;this.mc=new Hammer.Manager(this.mapCanvas);this.mc.add(new Hammer.Pan);this.mc.add(new Hammer.Tap);this.mc.add(new Hammer.Pinch);this.mc.on("panstart",function(){d.startDy=d.dy;d.startDx=d.dx});this.mc.on("panmove",function(t){d.showRadar();d.setMatrix({scale:d.scale,dx:d.startDx+t.deltaX,dy:d.startDy+t.deltaY});d.updateMap()});this.mc.on("panend",function(){d.checkBoundary();d.updateMap()});this.mc.on("pinchstart",function(){d.mc.get("pan").set({enable:false})});this.mc.on("pinchmove",function(t){var i=d.scale*t.scale;i<=d.minScale&&(i=d.minScale);i>=d.maxScale&&(i=d.maxScale);var e=t.center.x-d.mapOffset.left,a=t.center.x-d.mapOffset.top,s=parseInt(e/d.scale,10),r=parseInt(a/d.scale,10),n=parseInt(e/i,10),h=parseInt(a/i,10);d.setMatrix({scale:i,dx:d.dx-(s-n),dy:d.dy-(r-h)});d.checkBoundary();d.updateMap()});this.mc.on("pinchend",function(){d.mc.get("pan").set({enable:true})});this.mc.on("tap",this.handleMapTap)}},{key:"selectSeats",value:function t(i){var e=this;var a="";a=this.isSelected(i)?"dselected":"selected";if(a==="dselected"||a==="selected"){a==="selected"?this.addSeletedSite(i):this.removeSelectedSite(i);this.renderMap(this.mapCtx);this.renderRadar(this.radarCtx);this.selectedSites.forEach(function(t){e.renderSite(e.mapCtx,{color:e.getSiteColor(t),site:t,redraw:true});e.mapConfig.radar&&e.renderRadarSite(e.radarCtx,{color:e.getSiteColor(t),site:t,redraw:true})});this.mapConfig.onSelected&&this.mapConfig.onSelected.call(this,this.selectedSites,a)}}},{key:"isSelected",value:function t(i){return this.selectedSites.some(function(t){return t.siteId===i.siteId})}},{key:"addSeletedSite",value:function t(i){if(!this.isSelected(i)){this.selectedSites[0]=i}}},{key:"removeSelectedSite",value:function t(i){this.selectedSites=this.selectedSites.filter(function(t){return t.siteId!==i.siteId})}},{key:"canSelect",value:function t(i){return i.status==="1"}},{key:"checkBoundary",value:function t(){var i=this.dx,e=this.dy,a=this.scale,s=this.viewWidth,r=this.viewHeight,n=this.mapWidth*a,h=this.mapHeight*a;if(s>=n){var d=(s-n)/2;i!==d&&(i=d)}else{i>0&&(i=0);i<-(n-s)&&(i=-(n-s))}if(r-this.mapConfig.offset.dy>=h){e=this.mapConfig.offset.dy}else{e>this.mapConfig.offset.dy&&(e=this.mapConfig.offset.dy);e<r-h&&(e=r-h)}this.dx=i;this.dy=e}},{key:"setMatrix",value:function t(i){var e=i.dy,a=i.dx,s=i.scale;e&&(this.dy=e);a&&(this.dx=a);s&&(this.scale=s)}},{key:"renderMap",value:function t(i){var e=this;if(i){i.save();i.setTransform(1,0,0,1,0,0);i.clearRect(0,0,this.viewWidth*this.dpr,this.viewHeight*this.dpr);i.restore();i.setTransform(this.scale*this.dpr,0,0,this.scale*this.dpr,this.dx*this.dpr,this.dy*this.dpr);this.mapData.site.forEach(function(t){e.renderSite(i,{color:e.getSiteColor(t),site:t})});i.save()}}},{key:"renderRadar",value:function t(i){var e=this;if(!this.mapConfig.radar)return;this.mapData.site.forEach(function(t){e.renderRadarSite(i,{color:e.getSiteColor(t),site:t})})}},{key:"renderRadarSite",value:function t(i,e){var a=e.site,s=e.color,r=e.redraw;var n=a.rx,h=a.ry;i.fillStyle=s;if(r){i.clearRect(n,h,this.mapConfig.radarSiteWidth,this.mapConfig.radarSiteHeight);i.fillRect(n,h,this.mapConfig.radarSiteWidth,this.mapConfig.radarSiteHeight)}else{i.fillRect(n,h,this.mapConfig.radarSiteWidth,this.mapConfig.radarSiteHeight)}}},{key:"renderSite",value:function t(i,e){var a=e.site,s=e.color,r=e.redraw;var n=a.vx,h=a.vy;i.fillStyle=s;if(r){i.clearRect(n,h,this.mapConfig.siteWidth,this.mapConfig.siteHeight);i.fillRect(n,h,this.mapConfig.siteWidth,this.mapConfig.siteHeight)}else{i.fillRect(n,h,this.mapConfig.siteWidth,this.mapConfig.siteHeight)}}},{key:"updateMap",value:function t(){this.updateRadar();this.renderMap(this.mapCtx);this.updateIndex()}},{key:"updateIndex",value:function t(){var i=this.dx;var e=this.dy;var a=this.scale;this.yindex.css("transform","translate3d(0, ".concat(e-this.mapConfig.offset.dy,"px,0)"));this.yindex.find("ul").css("line-height","".concat((this.siteHeight+this.siteMargin)*a,"px"));this.xindex.css({transform:"translate3d(".concat(i-this.mapConfig.offset.dx,"px, 0 ,0)"),left:19*a});this.xindex.find("ul>li").css("width",(this.siteWidth+this.siteMargin)*a)}},{key:"updateRadar",value:function t(){if(!this.mapConfig.radar)return;var i=this.mapWidth*this.scale,e=this.mapHeight*this.scale,a=this.viewWidth,s=this.viewHeight,r=a/i,n=s/e,h=-this.dx/i*this.radarWidth,d=-(this.dy-this.mapConfig.offset.dy)/e*this.radarHeight;$(this.radarFrame).css({width:this.radarWidth*(r>1?1:r),height:this.radarHeight*(n>1?1:n),transform:"translate3d(".concat(h,"px, ").concat(d,"px,0)")})}},{key:"showRadar",value:function t(){var i=this;if(!this.mapConfig.radar)return;this.timer&&clearTimeout(this.timer);$(this.radarElement).addClass("active");this.timer=setTimeout(function(){$(i.radarElement).removeClass("active")},2e3)}},{key:"getSiteColor",value:function t(i){var e=this.mapConfig,a=e.siteColor,s=e.siteCtnColor,r=e.siteSelectedColor;return this.isSelected(i)?r:i.status==1?a:s}}]);return e}();